<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Comparison map of energy</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.css" type="text/css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.js"></script>
    <script charset="utf-8" src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script charset="utf-8" src="https://cdnjs.cloudflare.com/ajax/libs/dimple/2.3.0/dimple.latest.min.js"></script>
    <script type="text/javascript" src="https://lib.baomitu.com/echarts/4.9.0-rc.1/echarts.js"></script>
    <script type="text/javascript" src="./static/geojson.js"></script>
    <script language="JavaScript" type="text/javascript" src="/js/jquery-1.2.6.min.js"></script>
    <script language="JavaScript" type="text/javascript" src="/js/jquery-ui-personalized-1.5.2.packed.js"></script>
   <script language="JavaScript" type="text/javascript" src="/js/sprinkle.js"></script>
    <style>
      
     p{
    font-size:14px;
  }
     h1 {
    font-size: 20px;
    line-height: 30px;
  }

     h2 {
    font-size: 14px;
    line-height: 20px;
    margin-bottom: 10px;
  }
     h3{
    font-size:8px;
  }
     h4{
    font-size:14px;
    margin:0px;
    font-weight:normal;
  }
  a {
    text-decoration: none;
    color: #2DC4B2;
  }
   #iframe-shrink{transform:scale();left: -400px;top: -170px;}
    .row {
    height: 12px;
    width: 100%;
  }

   .colors {
    background: linear-gradient(to right,blue,red);
    margin-bottom: 5px;
  }
   .slider {
    margin-bottom: 20px;
  }

    html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
  }
    .map {
        position: absolute;
        height: 100%;
        width: 100%;
        overflow: hidden;
  }
    
   .wrapper{
        position: relative;
        margin: 10px;
        width: 240px;
        background-color: white;
        padding: 10px 20px;
  }
   .wrapper .title{
        font-size: 18px;
        margin-bottom: 10px;
  }
      
    .label {
        width: 15%;
        display: inline-block;
        text-align: center;
  }
    .echart-view{
        position: absolute;
        background-color: Gainsboro;
        right: 20px;
        top: 320px;
        width: 350px;
        height: 360px;
        padding: 10px;
  }
        .note{
        font-size: 14px;
        
  }
    </style>
  </head>

  <body>

    <div id="comparison-container">
      <div id="before" class="map"></div>
      <div id="after" class="map"></div>
    </div>
    <div class="wrapper">
      <div class="title">
          <h1>The trend of road transport consumption for different fuels used in London boroughs </h1></div>
         <h3>Note: We choosing the indicator of DIESEL cars/PETROL cars</h3>
          <p> Dark style shows the past data (from 2002 to 2007), and light style shows the recent data (from 2008 to 2013) for compare. Also, the time point of 2007 is the year when London became the host city of 2012 Olympics</p>
        <p> Checking the more information by clicking on the sepcific boroughs!</p>
       <div class="slider">
        <h2>Percentage</h2>
      <div class="row colors">
      </div>
      <div class="row labels">
        <div class="label">0.2</div>
        <div class="label">0.4</div>
        <div class="label">0.6</div>
        <div class="label">0.8</div>
        <div class="label">1.0</div>
        <div class="label">10.0 </div>
      </div>  
        </div>      
      <div class="slider">
          <h2>Past year: <span class="slider-value1">2005</span> </h2>
        <div class="slider-bar">
          <input style="width:200px" id='slider1' type='range' min='2002' max='2007' step='1' value='2005' list='tickmarks' />
        </div>
      </div>
      <div class="slider">
        <h2>Recent year:  <span class="slider-value2">2011</span> </h2>
        <div class="slider-bar">
          <input style="width:200px" id='slider2' type='range' min='2008' max='2013' step='1' value='2011' list='tickmarks' />
        </div>
      </div>
      <h3>Data of Road Transport Energy Consumption collected from  <a href="https://data.london.gov.uk/dataset/road-transport-energy-consumption-borough">London Datastore</a>.</h3> 
    </div>
    <div class="echart-view" id="chart"></div>
    <script>
        const App = {
        init: function () {
          this.beforeYear = 2005;
          this.afterYear = 2011;
          this.bindEvents();
          this.initMap();
        },
            
            initMap: function () {
          mapboxgl.accessToken = "pk.eyJ1IjoiaG9uZzA3MDciLCJhIjoiY2tqdmUyMnB2MDgyZzJ2bXJpejlwbjdmNiJ9.BEIE3shUNtLrjrss0bmuRg";
          this.beforeMap = new mapboxgl.Map({
            container: "before",
            style: "mapbox://styles/hong0707/ckontmjx253qy17o25fm8lpd1",
            center: [-0.1, 51.5],
            minZoom: 9.3,
            maxZoom: 13,
            zoom: 9
          });
          this.afterMap = new mapboxgl.Map({
            container: 'after',
            style: 'mapbox://styles/hong0707/ckontjb2e3s2z18ogbk3xf4xr',
            center: [-0.1, 51.5],
            minZoom: 9.3,
            maxZoom: 13,
            zoom: 9
          });

          this.map = new mapboxgl.Compare(this.beforeMap, this.afterMap, '#comparison-container');
          this.beforeMap.on('load', () => {
            this.beforeMap.addSource('geojson1', {
              type: "geojson",
              data: geojson 
            });

            this.afterMap.addSource('geojson', {
              type: "geojson",
              data: geojson 
            });

          // this.beforeMap.addLayer({
          //   id: "lineLabel",
          //   type: "symbol",
          //   source: "geojson1",
          //   layout: {
          //     "symbol-placement": "line-center",
          //     "text-field": ["get", "name"],
          //     "text-size": 12,
          //     "text-offset": [0, 1],
          //   },
          // });
    
            this.addBeforeLayer();
            this.addAfterLayer();
            this.addBeforeEvent();
            this.addAfterEvent();
          });
        },
        addBeforeLayer: function () {
          this.beforeMap.addLayer({
            id: `${this.beforeYear}label`,
            type: "symbol",
            source: "geojson1",
            layout: {
              "symbol-placement": "line-center",
              "text-field": ["get", "name"],
              "text-size": 16,
              "text-offset": [0, 1],
            },
          });
          this.beforeMap.addLayer({
            id: `${this.beforeYear}`,
            type: "fill",
            source: "geojson1",
            layout: {},
            paint: {
              "fill-color": {
                property: `ratio_${this.beforeYear}`,
                stops:  [
                  [0.2, '#2636D9'],
                  [0.4,'#2674D9'],
                  [0.6,'#7126D9'],
                  [0.8, '#D926D9'],
                  [1,  '#D9264B'],
                  [10, '#D9262B']
                ],
              },
              "fill-opacity": 0.85,
            },
          });
          // this.beforeMap.addLayer({
          //   id: `${this.beforeYear}label`,
          //   type: "symbol",
          //   source: "geojson1",
          //   layout: {
          //     "symbol-placement": "line-center",
          //     "text-field": ["get", "name"],
          //     "text-size": 16,
          //     "text-offset": [0, 1],
          //   },
          // });
        },
        addAfterLayer: function () {
          this.afterMap.addLayer({
            id: `${this.afterYear}`,
            type: "fill",
            source: "geojson",
            layout: {},
            paint: {
              "fill-color": {
                property: `ratio_${this.afterYear}`,
                stops:  [
                   [0.2, '#2636D9'],
                  [0.4,'#2674D9'],
                  [0.6,'#7126D9'],
                  [0.8, '#D926D9'],
                  [1,  '#D9264B'],
                  [10, '#D9262B']
                ],
              },
              "fill-opacity": 0.85,
            },
          });
        },

        addBeforeEvent: function(){
          this.beforeMap.on('click', `${this.beforeYear}`, (e) => {
            const currentYear = Object.keys(e.features[0].properties).find((o) => o.includes(this.beforeYear));
            const html = `
              <div style="font-size:14px">
                <div>Year: ${this.beforeYear}</div>
                <div>Area: ${e.features[0].properties.name}</div>
                <div>Ratio: ${(e.features[0].properties[currentYear]).toFixed(2)}</div>
              </div>
            `
            new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(this.beforeMap);
          });
        },
        addAfterEvent: function(){
          this.afterMap.on('click', `${this.afterYear}`, (e) => {
            const currentYear = Object.keys(e.features[0].properties).find((o) => o.includes(this.afterYear));
            const html = `
              <div style="font-size:14px">
              <div>Year: ${this.afterYear}</div>
              <div>Area: ${e.features[0].properties.name}</div>
              <div>Ratio: ${(e.features[0].properties[currentYear]).toFixed(2)}</div>
            </div>
            `
          new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(this.afterMap);
          });
        },
        removeBeforeLayer: function (){
          ['2002', '2003', '2004', '2005', '2006', '2007'].map((o) => {
            if (this.beforeMap.getLayer(o)) {
              this.beforeMap.removeLayer(o);
            }
          });
        },
        removeAfterLayer: function (){
          ['2008', '2009', '2010', '2011', '2012', '2013'].map((o) => {
            if (this.afterMap.getLayer(o)) {
              this.afterMap.removeLayer(o);
            }
          });
        },
        bindEvents: function () {

          document.getElementById("slider1").addEventListener("input", (e) => {
             this.beforeYear = Number(e.target.value);
            $(".slider-value1").html(e.target.value);
            this.removeBeforeLayer();
            this.addBeforeLayer();
            this.addBeforeEvent();
          });

          document.getElementById("slider2").addEventListener("input", (e) => {
            this.afterYear = Number(e.target.value);
            $(".slider-value2").html(e.target.value);
            this.removeAfterLayer();
            this.addAfterLayer();
            this.addAfterEvent();
          });
        },
      };
      App.init();
    </script>
      <div class="echart-view" id="note">
          <iframe id="iframe-shrink"  src="speed.html" height="280px" width="350px" frameBorder="0" scrolling="no"></iframe> 
          <p>Because of the global economic downturn and the riots of 2011, the speed rate of Bioenergy and waste decline sharply.</p>
          </div>
     
  </body>
</html>
